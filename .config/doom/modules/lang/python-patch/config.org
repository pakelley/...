#+TITLE: Config
#+property: header-args:emacs-lisp :tangle yes
#+property: header-args:elisp :tangle yes

* Packages
#+begin_src elisp :tangle packages.el
(package! numpydoc)
#+end_src

* conda
#+begin_src elisp :noweb no-export
(use-package! anaconda-mode
  :defer t
  :config
  <<conda-dirs>>
  <<conda-autoactivate>>
  )
#+end_src
Set path to dirs, so `conda.el` can find them. Note: I set my conda envs to save to a xdg-based path by setting the `env_dirs` property in `~/.condarc` to `~/.config/conda/envs`
#+name: conda-dirs
#+begin_src elisp :tangle no
(setq conda-anaconda-home "/opt/miniconda3")
(setq conda-env-home-directory "/Users/pakelley/.config/conda")
#+end_src
Set up auto-activation of conda envs in projects. For example, in the project root directory you could add the following to a `.dir-locals.el` file:
#+begin_src elisp :tangle no
((python-mode . ((conda-project-env-path . "name-of-my-env"))))
#+end_src
which would tell `conda.el` to use that environment. Notably, you can use the name of the env (rather than the path, as the var name implies).
#+name: conda-autoactivate
#+begin_src elisp :tangle no
(conda-env-autoactivate-mode t)
#+end_src
* numpydoc
#+begin_src emacs-lisp :tangle yes
(use-package! numpydoc
  :after python
  :custom
  (numpydoc-insertion-style 'yas)
  :config
  (map! :localleader
        :map python-mode-map
        ("d" #'numpydoc-generate)))
#+end_src
* lsp
#+begin_src emacs-lisp
(defun +patch/get-pdm-venv-packages-path ()
  "For the current PDM project (using venv, rather than pep-582, to install
packages), find the path to the packages."
  (let ((packages-path
         (string-trim (shell-command-to-string "pdm venv --path in-project"))))
    (concat packages-path "/lib/python3.10/site-packages")))

(defun +patch/get-pdm-pep582-packages-path ()
  "For the current PDM project (using pep-582, rather than venv, to install
packages), find the path to the packages."
  (let ((packages-path
         (string-trim (shell-command-to-string "pdm info --packages"))))
    (concat packages-path "/lib")))

;; I don't think this works anymore... but I'm using the pyright-specific
;; method below. Keeping this around in case I migrate away from pyright.
(defun +patch/eglot-extraPaths-workspace-config (server)
  "For the current PDM project, dynamically generate a python lsp config."
  `(:python\.analysis (:extraPaths ,(vector (+patch/get-pdm-venv-packages-path)))))

(defun +patch/eglot-pyright-venv-workspace-config (server)
  "For the current PDM project, dynamically generate a python lsp config."
  `((:pyright .
     (:venvPath ,(projectile-project-root)
      :venv ".venv"
      :pythonPath  "./.venv/bin/python"))))

(setq-default eglot-workspace-configuration #'+patch/eglot-pyright-venv-workspace-config)

;; while we're at it, remove doom's hook to stop hearing errors about it
(remove-hook! 'python-mode-local-vars-hook #'+python-init-anaconda-mode-maybe-h)

#+end_src
* lint
** black
use [[https://github.com/psf/black][black]] for auto-formatting.
#+begin_src emacs-lisp :tangle packages.el
(package! blacken)
#+end_src
#+begin_src emacs-lisp :tangle yes
(use-package! blacken)
#+end_src
** isort
use [[https://github.com/PyCQA/isort][isort]] to sort imports.
** isort before black, so black takes precedence
#+begin_src emacs-lisp :tangle yes
(defun +patch-python/lint ()
  (py-isort-before-save)
  (blacken-buffer))
(add-hook 'before-save-hook #'+patch-python/lint)
#+end_src
